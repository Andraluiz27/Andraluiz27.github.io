<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LOFT - O Jogo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a; /* bg-slate-900 */
            color: #cbd5e1; /* text-slate-300 */
        }
        .card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            background-size: cover;
            background-position: center;
            border-radius: 8px;
            border: 2px solid transparent;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .card:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.2);
        }
        .card.selected {
            border-color: #38bdf8; /* border-sky-400 */
            box-shadow: 0 0 20px #38bdf8;
        }
        .board-cell {
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            transition: background-color 0.3s, border 0.3s, transform 0.5s;
            border: 2px solid transparent;
            background-size: cover;
            background-position: center;
        }
        .board-cell.highlight {
            background-color: rgba(45, 212, 191, 0.2); /* teal-400 com opacidade */
            border: 2px dashed #14b8a6; /* teal-500 */
        }
        .board-container {
            background-image: url('imagens/sala.png'); /* Imagem de fundo da sala */
            background-size: cover;
            background-position: center;
            padding: 1rem;
            border-radius: 0.5rem;
            border: 2px solid #334155; /* slate-700 */
            display: inline-block; /* Faz o container se ajustar ao conteúdo */
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        .modal-content {
            background-color: #1e293b; /* bg-slate-800 */
            padding: 2rem;
            border-radius: 0.75rem;
            border: 1px solid #334155; /* slate-700 */
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }
        .chip-btn.selected {
            background-color: #38bdf8; /* bg-sky-500 */
            border-color: #7dd3fc; /* border-sky-300 */
            color: white;
        }
    </style>
</head>
<body class="p-4 md:p-6">

    <!-- ===== LOBBY / TELA INICIAL ===== -->
    <div id="lobby" class="max-w-lg mx-auto">
        <div class="modal-content text-center">
            <h1 class="text-5xl font-bold text-teal-400 mb-2">LOFT</h1>
            <p class="text-slate-400 mb-8">Decore. Dispute. Domine.</p>
            
            <input type="text" id="player-name-input" placeholder="Digite seu nome" class="w-full bg-slate-700 border border-slate-600 focus:border-teal-500 focus:ring-teal-500 text-white p-3 rounded-md mb-4" maxlength="20">

            <button id="start-cpu-game-btn" class="w-full mb-4 px-6 py-3 bg-sky-600 hover:bg-sky-500 text-white font-bold rounded-lg shadow-lg transition-transform transform hover:scale-105">Jogar contra CPU</button>
            
            <div class="relative py-4">
              <div class="absolute inset-0 flex items-center">
                <div class="w-full border-b border-slate-700"></div>
              </div>
              <div class="relative flex justify-center">
                <span class="bg-slate-800 px-2 text-sm text-slate-500">OU</span>
              </div>
            </div>

            <div id="online-options">
                <h2 class="text-xl font-bold text-teal-300 mb-4">Jogar Online</h2>
                <button id="create-game-btn" class="w-full mb-4 px-6 py-3 bg-teal-600 hover:bg-teal-500 text-white font-bold rounded-lg shadow-lg transition-transform transform hover:scale-105">Criar Sala</button>
                <div id="game-id-section" class="hidden mb-4">
                    <p class="text-slate-400">Compartilhe este ID com seu amigo:</p>
                    <p id="game-id-display" class="bg-slate-900 text-teal-300 font-mono p-2 rounded mt-2 cursor-pointer" title="Clique para copiar"></p>
                </div>
                <div class="flex items-center gap-2">
                    <input type="text" id="join-game-input" placeholder="Cole o ID da Sala" class="w-full bg-slate-700 border border-slate-600 focus:border-teal-500 focus:ring-teal-500 text-white p-3 rounded-md">
                    <button id="join-game-btn" class="px-6 py-3 bg-fuchsia-600 hover:bg-fuchsia-500 text-white font-bold rounded-lg shadow-lg transition-transform transform hover:scale-105">Entrar</button>
                </div>
                <p id="lobby-status" class="text-amber-400 h-8 mt-2"></p>
            </div>
        </div>
    </div>

    <!-- ===== ÁREA PRINCIPAL DO JOGO ===== -->
    <main id="game-container" class="hidden max-w-screen-xl mx-auto">
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">

            <!-- Coluna Principal do Jogo (Ocupa 3/4 da tela) -->
            <div class="lg:col-span-3 flex flex-col items-center gap-4">
                <!-- Área do Oponente -->
                <div id="opponent-panel" class="w-full bg-slate-800/80 backdrop-blur-sm p-3 rounded-lg border-2 border-transparent transition-all duration-300">
                    <div class="flex justify-between items-center">
                        <h2 id="opponent-name" class="text-xl font-bold text-fuchsia-400">Oponente (Extravagante)</h2>
                        <p class="text-sm text-slate-400">Fichas: <span id="opponent-chips" class="font-semibold">3x[5], 2x[7]</span></p>
                    </div>
                </div>

                <!-- Tabuleiro Principal -->
                <div class="board-container">
                    <div id="board" class="grid grid-cols-3 grid-rows-3 gap-4">
                        <!-- Células do tabuleiro 3x3 serão geradas aqui -->
                    </div>
                </div>
                
                <!-- Área do Jogador -->
                <div id="player-panel" class="w-full bg-slate-800/80 backdrop-blur-sm p-3 rounded-lg border-2 border-transparent transition-all duration-300">
                     <div class="flex justify-between items-center mb-2">
                        <h2 id="player-name" class="text-xl font-bold text-sky-400">Você (Moderno)</h2>
                        <p class="text-sm text-slate-400">Fichas: <span id="player-chips" class="font-semibold">3x[5], 2x[7]</span></p>
                    </div>
                    <div id="player-hand" class="flex justify-center flex-wrap gap-4 min-h-[128px] items-center">
                        <!-- Cartas do jogador serão geradas aqui -->
                    </div>
                </div>
            </div>

            <!-- Barra Lateral de Informações (Ocupa 1/4 da tela) -->
            <div class="lg:col-span-1 flex flex-col gap-4">
                <div class="bg-slate-800 p-4 rounded-lg">
                    <h2 class="text-2xl font-bold text-teal-400 mb-2">Placar</h2>
                    <p class="text-lg"><span id="player-score-name">Você</span>: <strong id="player-score" class="text-2xl text-sky-400">0</strong></p>
                    <p class="text-lg"><span id="opponent-score-name">CPU</span>: <strong id="opponent-score" class="text-2xl text-fuchsia-400">0</strong></p>
                </div>
                
                <div class="bg-slate-800 p-4 rounded-lg flex-grow">
                     <h3 class="text-xl font-bold text-teal-400">Turno <span id="current-turn">1</span> / 5</h3>
                     <p id="status-message" class="mt-2 text-teal-200 h-24">O jogo vai começar...</p>

                     <!-- Painel de Ações Dinâmico -->
                     <div id="action-panel" class="mt-4">
                        <div id="chip-panel" class="hidden">
                            <h3 class="font-bold mb-2 text-slate-300">Use suas Fichas</h3>
                            <div id="chip-buttons" class="flex flex-wrap gap-2 mb-3">
                               <!-- Botões de Ficha gerados aqui -->
                            </div>
                            <button id="confirm-chips-btn" class="w-full px-4 py-2 bg-sky-600 hover:bg-sky-500 rounded font-semibold">Confirmar Fichas</button>
                        </div>
                         <button id="next-turn-btn" class="hidden w-full px-4 py-3 bg-teal-600 hover:bg-teal-500 rounded font-bold text-lg">Próximo Turno</button>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Modal de Fim de Jogo -->
    <div id="end-game-modal" class="hidden modal-overlay">
        <div class="modal-content text-center">
            <h2 id="winner-text" class="text-4xl font-bold text-teal-300 mb-6"></h2>
            <p class="text-slate-400 mb-2">Placar Final</p>
            <p id="final-score-player" class="text-xl mb-1"></p>
            <p id="final-score-opponent" class="text-xl mb-6"></p>
            <button onclick="window.location.reload()" class="px-8 py-3 bg-teal-600 hover:bg-teal-500 text-white font-bold rounded-lg text-lg">Jogar Novamente</button>
        </div>
    </div>


    <!-- ===== SCRIPT DO JOGO (JAVASCRIPT) ===== -->
    <script type="module">
        // Importações do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // Cole aqui sua configuração do Firebase
        const firebaseConfig = {
          apiKey: "AIzaSyCud1NHoejuyxPaONKjZG9U5k2GxMXUFPQ",
          authDomain: "loft-86abf.firebaseapp.com",
          projectId: "loft-86abf",
          storageBucket: "loft-86abf.firebasestorage.app",
          messagingSenderId: "1018082448957",
          appId: "1:1018082448957:web:376c371daeff2ee0c53c54"
        };
        // =================================================================

        // Inicialização do Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'loft-game-default';
        const gamesCollectionPath = `/artifacts/${appId}/public/data/loft_games`;
        
        // ===== CONSTANTES E DADOS DO JOGO =====
        const VALORES_CARTAS = {
            "Vaso de Planta": [1, 10, 19, 28, 37], "Quadro": [2, 11, 20, 29, 38],
            "Relogio": [3, 12, 21, 30, 39], "Tapete": [4, 13, 22, 31, 40],
            "Mesa de Centro": [5, 14, 23, 32, 41], "Abajur": [6, 15, 24, 33, 42],
            "TV": [7, 16, 25, 34, 43], "Estante": [8, 17, 26, 35, 44],
            "Sofa": [9, 18, 27, 36, 45]
        };
        const TOTAL_TURNOS = 5;

        // ===== VARIÁVEIS DE ESTADO GLOBAIS =====
        let localGameState = {};
        let localPlayerId = null; // 'player1' ou 'player2'
        let gameId = null;
        let unsubscribe = null; // Função para parar de ouvir o onSnapshot
        
        let selectedCard = null; // Carta selecionada da mão
        let selectedChipValue = null; // Ficha selecionada

        // Elementos da UI
        const lobbyEl = document.getElementById('lobby');
        const gameContainerEl = document.getElementById('game-container');
        const statusMessageEl = document.getElementById('status-message');
        const boardEl = document.getElementById('board');
        const endGameModalEl = document.getElementById('end-game-modal');

        // ===== FUNÇÕES DE LÓGICA DO JOGO =====
        
        const delay = ms => new Promise(res => setTimeout(res, ms));

        function createEmptyBoard() {
            return {
                '0': { '0': null, '1': null, '2': null },
                '1': { '0': null, '1': null, '2': null },
                '2': { '0': null, '1': null, '2': null }
            };
        }

        function criar_baralho_completo(estilo) {
            const baralho = [];
            for (const [tipo, valores] of Object.entries(VALORES_CARTAS)) {
                for (const valor of valores) {
                    const nome_formatado = tipo.toLowerCase().replace(/ /g, '_');
                    // MODIFICAÇÃO: Apontando para a pasta local 'imagens'
                    const nome_ficheiro = `${estilo}_${nome_formatado}_${valor}.png`;
                    const caminho_imagem = `imagens/${nome_ficheiro}`;
                    
                    baralho.push({ 
                        tipo: tipo, 
                        valor: valor, 
                        imagem: caminho_imagem, 
                        dono: estilo, 
                        id: `${estilo}-${tipo}-${valor}`
                    });
                }
            }
            return baralho;
        }

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        async function updateFirestoreState(newState) {
            if (gameId && localGameState.gameMode === 'online') {
                try {
                    await setDoc(doc(db, gamesCollectionPath, gameId), newState, { merge: true });
                } catch (e) {
                    console.error("Erro ao atualizar o Firestore: ", e);
                    statusMessageEl.textContent = "Erro de conexão.";
                }
            }
        }
        
        // ===== RENDERIZAÇÃO DA UI =====

        function updateUI() {
            if (!localGameState || !localGameState.players) return;
            if (!localPlayerId) return;

            const player = localGameState.players[localPlayerId];
            const opponentId = localPlayerId === 'player1' ? 'player2' : 'player1';
            const opponent = localGameState.players[opponentId];
            
            document.getElementById('player-name').textContent = `${player.name} (Moderno)`;
            document.getElementById('opponent-name').textContent = `${opponent.name} (Extravagante)`;
            document.getElementById('player-score-name').textContent = player.name;
            document.getElementById('opponent-score-name').textContent = opponent.name;
            document.getElementById('player-score').textContent = player.points;
            document.getElementById('opponent-score').textContent = opponent.points;
            document.getElementById('current-turn').textContent = localGameState.turn;
            statusMessageEl.textContent = localGameState.statusMessage;
            
            const myTurn = localGameState.currentPlayerId === localPlayerId;
            document.getElementById('player-panel').style.borderColor = myTurn ? '#38bdf8' : 'transparent';
            document.getElementById('opponent-panel').style.borderColor = !myTurn ? '#e879f9' : 'transparent';
            
            const playerHandEl = document.getElementById('player-hand');
            playerHandEl.innerHTML = '';
            player.hand.forEach(card => {
                const cardEl = document.createElement('div');
                cardEl.className = 'card w-24 h-20 md:w-32 md:h-24 cursor-pointer';
                cardEl.style.backgroundImage = `url('${card.imagem}')`;
                if(selectedCard && selectedCard.id === card.id) {
                    cardEl.classList.add('selected');
                }
                cardEl.onclick = () => handleCardClick(card);
                playerHandEl.appendChild(cardEl);
            });
            
            boardEl.innerHTML = '';
            for (let i = 0; i < 3; i++) {
                for (let j = 0; j < 3; j++) {
                    const cellEl = document.createElement('div');
                    cellEl.className = 'board-cell flex items-center justify-center text-white font-bold text-lg w-32 h-24 md:w-40 md:h-28';
                    cellEl.dataset.row = i;
                    cellEl.dataset.col = j;
                    const cellState = localGameState.board[i][j];
                     if (cellState && cellState.card) {
                         cellEl.style.backgroundImage = `url('${cellState.card.imagem}')`;
                    } else if (localGameState.playsThisTurn[`${i},${j}`]) {
                         cellEl.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
                         cellEl.textContent = "Ocupado";
                    }
                    if (localGameState.highlightedCell && localGameState.highlightedCell[0] === i && localGameState.highlightedCell[1] === j) {
                        cellEl.classList.add('highlight');
                    }
                    cellEl.onclick = () => handleBoardCellClick(i, j);
                    boardEl.appendChild(cellEl);
                }
            }
            
            const playerChipsEl = document.getElementById('player-chips');
            playerChipsEl.textContent = `${player.chips[5]}x[5], ${player.chips[7]}x[7]`;
            const opponentChipsEl = document.getElementById('opponent-chips');
            opponentChipsEl.textContent = `${opponent.chips[5]}x[5], ${opponent.chips[7]}x[7]`;

            const chipPanel = document.getElementById('chip-panel');
            const nextTurnBtn = document.getElementById('next-turn-btn');
            const confirmChipsBtn = document.getElementById('confirm-chips-btn');

            chipPanel.classList.toggle('hidden', localGameState.phase !== 'SELECAO_FICHAS');
            if (localGameState.phase === 'SELECAO_FICHAS') {
                const chipButtonsEl = document.getElementById('chip-buttons');
                chipButtonsEl.innerHTML = '';
                if (!localGameState.confirmations[localPlayerId]) {
                    [...Array(player.chips[5])].forEach(() => createChipButton(5, chipButtonsEl));
                    [...Array(player.chips[7])].forEach(() => createChipButton(7, chipButtonsEl));
                    confirmChipsBtn.disabled = false;
                    confirmChipsBtn.textContent = 'Confirmar Fichas';
                } else {
                    confirmChipsBtn.disabled = true;
                    confirmChipsBtn.textContent = 'Aguardando Oponente';
                }
            }
            
            nextTurnBtn.classList.toggle('hidden', localGameState.phase !== 'FIM_TURNO' || localGameState.turnStarter !== localPlayerId);

            if (localGameState.phase === 'FIM_JOGO') {
                endGameModalEl.classList.remove('hidden');
                document.getElementById('winner-text').textContent = localGameState.winner;
                document.getElementById('final-score-player').textContent = `${player.name}: ${player.points}`;
                document.getElementById('final-score-opponent').textContent = `${opponent.name}: ${opponent.points}`;
            }
        }
        
        function createChipButton(value, container) {
            const chipBtn = document.createElement('button');
            chipBtn.className = 'chip-btn px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-md border-2 border-slate-500 font-semibold';
            chipBtn.textContent = value;
            chipBtn.onclick = () => handleChipClick(value, chipBtn);
            container.appendChild(chipBtn);
        }
        
        // ===== MANIPULADORES DE EVENTOS =====

        function handleCardClick(card) {
             const gs = localGameState;
             if (gs.currentPlayerId !== localPlayerId || gs.phase !== 'SELECAO_CARTAS') return;
             selectedCard = (selectedCard && selectedCard.id === card.id) ? null : card;
             updateUI();
        }

        async function handleBoardCellClick(row, col) {
            let gs = JSON.parse(JSON.stringify(localGameState));
            if (gs.currentPlayerId !== localPlayerId) return;

            if (gs.phase === 'SELECAO_CARTAS') {
                if (!selectedCard) { 
                    statusMessageEl.textContent = "Selecione uma carta da sua mão primeiro!"; 
                    return; 
                }
                const highlighted = gs.highlightedCell;
                if (!highlighted || highlighted[0] !== row || highlighted[1] !== col) { 
                    statusMessageEl.textContent = "Você só pode jogar no espaço destacado."; 
                    return; 
                }

                const playKey = `${row},${col}`;
                let play = gs.playsThisTurn[playKey] || { player1: null, player2: null };

                if (play[localPlayerId]) return;

                const player = gs.players[localPlayerId];
                player.hand = player.hand.filter(c => c.id !== selectedCard.id);
                play[localPlayerId] = { card: selectedCard, chip: 0 };
                gs.playsThisTurn[playKey] = play;
                
                selectedCard = null;

                if (localPlayerId === 'player1') {
                    gs.currentPlayerId = 'player2';
                    gs.statusMessage = `Vez de ${gs.players.player2.name} jogar no mesmo espaço.`;
                } else {
                    gs.spacesPlayedInRow++;
                    gs.currentPlayerId = gs.turnStarter; // Quem começa a linha, começa o próximo espaço
                    
                    if (gs.spacesPlayedInRow >= 3) {
                        gs.phase = 'SELECAO_FICHAS';
                        gs.highlightedCell = null;
                        gs.statusMessage = "Fase de Fichas! Adicione fichas se desejar.";
                    } else {
                        gs.highlightedCell = [gs.currentRow, gs.spacesPlayedInRow];
                        gs.statusMessage = `Vez de ${gs.players[gs.currentPlayerId].name} jogar no próximo espaço.`;
                    }
                }
            } else if (gs.phase === 'SELECAO_FICHAS') {
                 if (gs.confirmations[localPlayerId]) return;
                 if (selectedChipValue === null) { 
                     statusMessageEl.textContent = "Selecione uma ficha primeiro!";
                     return; 
                 }
                 if (row !== gs.currentRow) {
                      statusMessageEl.textContent = "Só pode colocar fichas na linha atual.";
                      return;
                 }
                 const playKey = `${row},${col}`;
                 const play = gs.playsThisTurn[playKey];
                 if (!play || !play[localPlayerId] || play[localPlayerId].chip > 0) return;
                 
                 const player = gs.players[localPlayerId];
                 if (player.chips[selectedChipValue] > 0) {
                     player.chips[selectedChipValue]--;
                     play[localPlayerId].chip = selectedChipValue;
                     selectedChipValue = null;
                     document.querySelectorAll('.chip-btn').forEach(b => b.classList.remove('selected'));
                 } else { 
                     statusMessageEl.textContent = `Você não tem mais fichas de valor ${selectedChipValue}.`; 
                 }
            }
            
            if (gs.gameMode === 'cpu') { 
                localGameState = gs; 
                updateUI(); 
                if (gs.currentPlayerId === 'player2' && gs.phase === 'SELECAO_CARTAS') {
                    setTimeout(() => runCpuTurn(gs), 1000);
                }
            } else { await updateFirestoreState(gs); }
        }
        
        function handleChipClick(value, buttonEl) {
             selectedChipValue = value;
             document.querySelectorAll('.chip-btn').forEach(btn => btn.classList.remove('selected'));
             buttonEl.classList.add('selected');
        }
        
        document.getElementById('confirm-chips-btn').addEventListener('click', async () => {
             let gs = JSON.parse(JSON.stringify(localGameState));
             if(gs.phase !== 'SELECAO_FICHAS' || gs.confirmations[localPlayerId]) return;
             
             gs.confirmations[localPlayerId] = true;
             gs.statusMessage = "Você confirmou. Aguardando oponente...";

             if (gs.gameMode === 'cpu') { 
                // CPU adiciona fichas e confirma
                const cpu = gs.players.player2;
                for(let col=0; col<3; col++){
                    const play = gs.playsThisTurn[`${gs.currentRow},${col}`];
                    if(play?.player2){
                        const cardVal = play.player2.card.valor;
                        if(cardVal > 30 && cpu.chips[7] > 0){
                            play.player2.chip = 7;
                            cpu.chips[7]--;
                        } else if (cardVal > 20 && cpu.chips[5] > 0){
                            play.player2.chip = 5;
                            cpu.chips[5]--;
                        }
                    }
                }
                gs.confirmations.player2 = true;
                localGameState = gs;
                updateUI();
                await startRowResolution();
             } else { 
                await updateFirestoreState(gs);
             }
        });

        document.getElementById('next-turn-btn').addEventListener('click', async () => {
            let gs = JSON.parse(JSON.stringify(localGameState));
            if(gs.phase !== 'FIM_TURNO' || gs.turnStarter !== localPlayerId) return;
            
            prepareNextTurn(gs);
            
            if (gs.gameMode === 'cpu') {
                localGameState = gs;
                updateUI();
            } else {
                await updateFirestoreState(gs);
            }
        });

        // ===== LÓGICA DE TURNO E PONTUAÇÃO =====

        async function startRowResolution() {
            let gs = JSON.parse(JSON.stringify(localGameState));
            gs.phase = 'REVELACAO';
            gs.statusMessage = `Revelando linha ${gs.currentRow + 1}...`;
            if (gs.gameMode === 'online') await updateFirestoreState(gs); else { localGameState = gs; updateUI(); }
            await delay(1000);

            // Revela as cartas da linha atual
            for (let col = 0; col < 3; col++) {
                const playKey = `${gs.currentRow},${col}`;
                const play = gs.playsThisTurn[playKey];
                if (!play || !play.player1 || !play.player2) continue;

                const p1Play = play.player1;
                const p2Play = play.player2;
                const p1Value = p1Play.card.valor + p1Play.chip;
                const p2Value = p2Play.card.valor + p2Play.chip;
                
                let winnerCard;
                if (p1Value > p2Value) winnerCard = p1Play.card;
                else if (p2Value > p1Value) winnerCard = p2Play.card;
                else winnerCard = p1Play.card; // Empate mantém a carta do P1 por padrão
                
                gs.board[gs.currentRow][col] = { card: winnerCard };
                if (gs.gameMode === 'online') await updateFirestoreState(gs); else { localGameState = gs; updateUI(); }
                await delay(1500);
            }

            // Após revelar a linha, decide o que fazer
            if (gs.currentRow >= 2) {
                // Fim do turno, calcular pontos
                gs = applySpecialRules(gs);
                gs = calculateScores(gs);
                
                if (gs.turn >= TOTAL_TURNOS) {
                    gs.phase = 'FIM_JOGO';
                    const p1 = gs.players.player1;
                    const p2 = gs.players.player2;
                    if(p1.points > p2.points) gs.winner = `${p1.name} venceu!`;
                    else if (p2.points > p1.points) gs.winner = `${p2.name} venceu!`;
                    else gs.winner = "Empate!";
                } else {
                    gs.phase = 'FIM_TURNO';
                    gs.statusMessage = `Turno ${gs.turn} finalizado! Clique em "Próximo Turno".`;
                }
            } else {
                // Prepara para a próxima linha
                gs.currentRow++;
                gs.spacesPlayedInRow = 0;
                gs.confirmations = { player1: false, player2: false };
                gs.highlightedCell = [gs.currentRow, 0];
                gs.phase = 'SELECAO_CARTAS';
                gs.statusMessage = `Prepare-se para a linha ${gs.currentRow + 1}. Vez de ${gs.players[gs.currentPlayerId].name}.`;
            }

            if (gs.gameMode === 'cpu') { localGameState = gs; updateUI(); } 
            else { await updateFirestoreState(gs); }
        }

        function applySpecialRules(gs) {
            let board = gs.board;
            // Regra de Anulação: Sofás (Horizontal)
            for(let r=0; r<3; r++){
                for(let c=0; c<2; c++){
                    const cell1 = board[r][c]?.card;
                    const cell2 = board[r][c+1]?.card;
                    if(cell1 && cell2 && cell1.tipo === 'Sofa' && cell2.tipo === 'Sofa' && cell1.dono !== cell2.dono){
                        board[r][c+1] = null;
                    }
                }
            }
             // Regra de Anulação: Estantes (Vertical)
            for(let c=0; c<3; c++){
                for(let r=0; r<2; r++){
                    const cell1 = board[r][c]?.card;
                    const cell2 = board[r+1][c]?.card;
                    if(cell1 && cell2 && cell1.tipo === 'Estante' && cell2.tipo === 'Estante' && cell1.dono !== cell2.dono){
                        board[r+1][c] = null;
                    }
                }
            }
            gs.board = board;
            return gs;
        }

        function calculateScores(gs) {
            let p1TurnPoints = 0;
            let p2TurnPoints = 0;
            const board = gs.board;

            // 1. Pontuação Básica: Mais mobílias
            let p1Cards = 0, p2Cards = 0;
            for(let r=0; r<3; r++) for(let c=0; c<3; c++) {
                if(board[r][c]?.card?.dono === 'moderno') p1Cards++;
                if(board[r][c]?.card?.dono === 'extravagante') p2Cards++;
            }
            if (p1Cards > p2Cards) p1TurnPoints += 5;
            if (p2Cards > p1Cards) p2TurnPoints += 5;

            // 2. Bônus de Organização
            const centerCard = board[1][1]?.card;
            if(centerCard && (centerCard.tipo === 'Mesa de Centro' || centerCard.tipo === 'Tapete')) {
                if (centerCard.dono === 'moderno') p1TurnPoints += 2; else p2TurnPoints += 2;
            }

            const lines = [
                [[0,0],[0,1],[0,2]], [[1,0],[1,1],[1,2]], [[2,0],[2,1],[2,2]], // Rows
                [[0,0],[1,0],[2,0]], [[0,1],[1,1],[2,1]], [[0,2],[1,2],[2,2]], // Cols
                [[0,0],[1,1],[2,2]], [[0,2],[1,1],[2,0]]  // Diags
            ];
            lines.forEach(line => {
                const cardsInLine = line.map(([r,c]) => board[r][c]?.card).filter(Boolean);
                if(cardsInLine.length === 3) {
                    const owner = cardsInLine[0].dono;
                    if(cardsInLine.every(c => c.dono === owner)) {
                        const hasEstante = cardsInLine.some(c => c.tipo === 'Estante');
                        const points = hasEstante ? 2 : 1;
                        if(owner === 'moderno') p1TurnPoints += points; else p2TurnPoints += points;
                    }
                }
            });

            for(let r=0; r<3; r++) { // Horizontal
                const rowCards = [board[r][0]?.card, board[r][1]?.card, board[r][2]?.card];
                if(rowCards.every(Boolean) && rowCards[0].tipo === 'Sofa' && rowCards[1].tipo === 'Mesa de Centro' && rowCards[2].tipo === 'TV') {
                    if(rowCards.every(c => c.dono === rowCards[0].dono)) {
                        if(rowCards[0].dono === 'moderno') p1TurnPoints += 3; else p2TurnPoints += 3;
                    }
                }
            }
             for(let c=0; c<3; c++) { // Vertical
                const colCards = [board[0][c]?.card, board[1][c]?.card, board[2][c]?.card];
                if(colCards.every(Boolean) && colCards[0].tipo === 'Sofa' && colCards[1].tipo === 'Mesa de Centro' && colCards[2].tipo === 'TV') {
                    if(colCards.every(c => c.dono === colCards[0].dono)) {
                        if(colCards[0].dono === 'moderno') p1TurnPoints += 3; else p2TurnPoints += 3;
                    }
                }
            }
            
            gs.players.player1.points += p1TurnPoints;
            gs.players.player2.points += p2TurnPoints;
            gs.statusMessage = `Pontuação do turno: ${gs.players.player1.name} +${p1TurnPoints}, ${gs.players.player2.name} +${p2TurnPoints}.`;

            return gs;
        }

        function prepareNextTurn(gs) {
            gs.turn++;
            gs.board = createEmptyBoard();
            gs.playsThisTurn = {};
            gs.currentRow = 0;
            gs.spacesPlayedInRow = 0;
            gs.confirmations = { player1: false, player2: false };
            gs.turnStarter = gs.turnStarter === 'player1' ? 'player2' : 'player1';
            gs.currentPlayerId = gs.turnStarter;
            gs.highlightedCell = [0, 0];
            gs.phase = 'SELECAO_CARTAS';
            gs.statusMessage = `Turno ${gs.turn}! Vez de ${gs.players[gs.currentPlayerId].name}.`;

            for(let i=0; i<9; i++) {
                if(gs.decks.moderno.length > 0) gs.players.player1.hand.push(gs.decks.moderno.pop());
                if(gs.decks.extravagante.length > 0) gs.players.player2.hand.push(gs.decks.extravagante.pop());
            }

            return gs;
        }
        
        // ===== INICIALIZAÇÃO DO JOGO =====
        
        function createInitialGameState(player1Name, player2Name, mode) {
            const baralhoModerno = shuffle(criar_baralho_completo('moderno'));
            const baralhoExtravagante = shuffle(criar_baralho_completo('extravagante'));
            return {
                gameId, gameMode: mode, turn: 1, phase: 'SELECAO_CARTAS',
                board: createEmptyBoard(),
                players: {
                    player1: { name: player1Name, style: 'moderno', points: 0, hand: baralhoModerno.splice(0, 12), chips: { '5': 3, '7': 2 } },
                    player2: { name: player2Name, style: 'extravagante', points: 0, hand: baralhoExtravagante.splice(0, 12), chips: { '5': 3, '7': 2 } }
                },
                decks: {
                    moderno: baralhoModerno,
                    extravagante: baralhoExtravagante
                },
                turnStarter: 'player1',
                currentPlayerId: 'player1', highlightedCell: [0, 0], currentRow: 0,
                spacesPlayedInRow: 0, playsThisTurn: {},
                confirmations: { player1: false, player2: false },
                statusMessage: `Aguardando oponente...`,
            };
        }
        
        // ===== LÓGICA DA CPU (Simplificada) =====
        function runCpuTurn(gs) {
             if (gs.currentPlayerId !== 'player2' || gs.phase !== 'SELECAO_CARTAS') return;

             if(gs.highlightedCell) {
                 const cpu = gs.players.player2;
                 const cardToPlay = cpu.hand[0]; 
                 if(cardToPlay){
                    selectedCard = cardToPlay;
                    handleBoardCellClick(gs.highlightedCell[0], gs.highlightedCell[1]);
                 }
             }
        }
        
        // ===== LISTENERS DE UI E FIREBASE =====
        const lobbyStatusEl = document.getElementById('lobby-status');

        document.getElementById('start-cpu-game-btn').addEventListener('click', () => {
            const playerName = document.getElementById('player-name-input').value.trim() || "Jogador";
            gameId = 'local_cpu_game';
            localPlayerId = 'player1';
            localGameState = createInitialGameState(playerName, "CPU", "cpu");
            localGameState.statusMessage = `${playerName} começa o jogo! Jogue no espaço destacado.`;
            lobbyEl.classList.add('hidden');
            gameContainerEl.classList.remove('hidden');
            updateUI();
        });
        
        document.getElementById('create-game-btn').addEventListener('click', async () => {
             const playerName = document.getElementById('player-name-input').value.trim();
             if (!playerName) { 
                 lobbyStatusEl.textContent = "Por favor, digite seu nome.";
                 return; 
             }
             
             lobbyStatusEl.textContent = 'Criando sala...';
             const newGameId = Math.random().toString(36).substring(2, 6).toUpperCase();
             gameId = newGameId;
             localPlayerId = 'player1';
             
             try {
                const initialState = createInitialGameState(playerName, "Aguardando...", "online");
                await setDoc(doc(db, gamesCollectionPath, gameId), initialState);

                document.getElementById('game-id-display').textContent = newGameId;
                document.getElementById('game-id-section').classList.remove('hidden');
                document.getElementById('create-game-btn').disabled = true;
                document.getElementById('join-game-btn').disabled = true;
                lobbyStatusEl.textContent = 'Aguardando oponente...';
                
                listenToGameChanges(newGameId);
             } catch (error) {
                console.error("Erro ao criar sala:", error);
                lobbyStatusEl.textContent = 'Erro ao criar a sala. Tente novamente.';
             }
        });

        document.getElementById('join-game-btn').addEventListener('click', async () => {
            const joinId = document.getElementById('join-game-input').value.trim().toUpperCase();
            const playerName = document.getElementById('player-name-input').value.trim();
            if (!joinId || !playerName) { 
                lobbyStatusEl.textContent = "Preencha o ID da sala e seu nome.";
                return;
            }

            lobbyStatusEl.textContent = 'Entrando na sala...';
            const gameRef = doc(db, gamesCollectionPath, joinId);
            
            try {
                const gameSnap = await getDoc(gameRef);

                if (gameSnap.exists() && gameSnap.data().players.player2.name === "Aguardando...") {
                    gameId = joinId;
                    localPlayerId = 'player2';
                    await updateDoc(gameRef, {
                        'players.player2.name': playerName,
                        'statusMessage': `${gameSnap.data().players.player1.name} começa o jogo!`
                    });
                    listenToGameChanges(joinId);
                } else { 
                    lobbyStatusEl.textContent = "Sala não encontrada ou já está cheia!";
                }
            } catch (error) {
                console.error("Erro ao entrar na sala:", error);
                lobbyStatusEl.textContent = 'Erro ao entrar na sala. Verifique o ID.';
            }
        });
        
        function listenToGameChanges(id) {
            if (unsubscribe) unsubscribe();
            unsubscribe = onSnapshot(doc(db, gamesCollectionPath, id), async (doc) => {
                if (doc.exists()) {
                    const serverState = doc.data();
                    const wasConfirmationPhase = localGameState.phase === 'SELECAO_FICHAS';
                    localGameState = serverState;
                    const player2Joined = serverState.players.player2.name !== "Aguardando...";
                    
                    if (lobbyEl.className.indexOf('hidden') === -1 && player2Joined) {
                        lobbyEl.classList.add('hidden');
                        gameContainerEl.classList.remove('hidden');
                    }
                    
                    if (gameContainerEl.className.indexOf('hidden') === -1) {
                        updateUI();
                    }

                    const bothConfirmed = serverState.confirmations.player1 && serverState.confirmations.player2;
                    if(wasConfirmationPhase && bothConfirmed && localPlayerId === 'player1') {
                         await startRowResolution();
                    }

                } else { 
                    if(localPlayerId === 'player2') {
                        lobbyStatusEl.textContent = "A sala foi fechada pelo anfitrião.";
                        setTimeout(() => window.location.reload(), 3000);
                    }
                }
            });
        }
        
        onAuthStateChanged(auth, (user) => {
            if (!user) { signInAnonymously(auth).catch(console.error); }
        });

        window.addEventListener('beforeunload', () => {
            if(localGameState.gameMode === 'online' && localPlayerId === 'player1' && gameId) {
                deleteDoc(doc(db, gamesCollectionPath, gameId));
            }
        });
        
    </script>
</body>
</html>

